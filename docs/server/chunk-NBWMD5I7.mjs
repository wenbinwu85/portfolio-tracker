import './polyfills.server.mjs';
import{d as D}from"./chunk-M6CNKOEM.mjs";import{a as b,b as I,c as v}from"./chunk-HTJLJ2KF.mjs";import{B as m,M as u,Mc as y,X as H,aa as a,g as c,l as p,v as g}from"./chunk-6LZGNP3H.mjs";import{a as d,b as f}from"./chunk-5XUXGTUW.mjs";var j=(()=>{let l=class l{constructor(t,o,e){this.document=t,this.http=o,this.router=e,this.httpOptions={headers:new b().set("content-type","application/json").set("Access-Control-Allow-Origin","*")},this.backendUrl="https://portfolio-tracker-backend-5ys2.onrender.com",this.portfolioSymbols=[],this.portfolioHoldings={},this.portfolioData={},this.portfolioTechnicalInsights={},this.portfolioDividendHistory={},this.isLoadingData=new c(!1),this.hasPortfolioData=new c(!1),this.localStorage=this.document.defaultView?.localStorage,this.generatePortfolioDataFromLocalStorage()}get marketState(){return this.portfolioDataArray[0].marketState}get portfolioDataArray(){return Object.values(this.portfolioData)}get portfolioHoldingsArray(){return Object.values(this.portfolioHoldings)}get portfolioDividendHistoryArray(){return Object.values(this.portfolioDividendHistory)}get portfolioTechnicalInsightsArray(){return Object.values(this.portfolioTechnicalInsights)}error(t){let o=t.error instanceof ErrorEvent?t.error.message:`Error Code: ${t.status} Message: ${t.message}`;return p({data:[],message:o,status:500})}wrapHttpCall(t,o=this.httpOptions){return this.http.get(t,o).pipe(u(2),m(this.error))}sanityCheck(){console.log("%c ----- Sanity Check -----","background: teal; color: white");let t=this.portfolioSymbols.length>0&&this.portfolioSymbols.length===this.portfolioDataArray.length,o=this.portfolioHoldingsArray.length===this.portfolioSymbols.length+8,e=this.portfolioTechnicalInsightsArray.length===this.portfolioSymbols.length,i=this.portfolioDividendHistory!=null;return console.log("Symbols:",this.portfolioSymbols),console.log("Holdings:",this.portfolioSymbols.length),console.log("Portfolio data length = number of symbols:",t),console.log("Holdings length is = number of symbols + 8:",o),console.log("Technical insights length = number of symbols:",e),console.log("Dividend history data is not empty:",i),console.log("%c ------------------------","background: teal; color: white"),t&&o&&e?(console.log("Sanity Check Passed!"),!0):(console.log("Sanity Check Failed!"),!1)}getItem(t){let o=this.localStorage?.getItem(t);return o?JSON.parse(o):null}setItem(t,o){this.localStorage?.setItem(t,JSON.stringify(o))}generatePortfolioDataFromLocalStorage(){this.isLoadingData.next(!0);let t=this.getItem("portfolioSymbols"),o=this.getItem("portfolioHoldings"),e=this.getItem("portfolioTechInsights");t&&o&&e&&(this.portfolioSymbols=t,this.portfolioHoldings=o,this.portfolioTechnicalInsights=e,t.forEach(i=>{this.portfolioData[i]=this.getItem(i),this.portfolioDividendHistory[i]=this.getItem(i+"DividendHistory")}),this.hasPortfolioData.next(!0)),this.isLoadingData.next(!1),this.sanityCheck()}generatePortfolioData(t){this.isLoadingData.next(!0),this.setItem("fileContent",t),this.portfolioHoldings.positionsHeld=0,this.portfolioHoldings.marketValue=0,this.portfolioHoldings.totalAmountInvested=0,this.portfolioHoldings.dividendIncome=0,this.portfolioHoldings.unrealizedGain=0,this.portfolioHoldings.unrealizedGainPercent=0,this.portfolioHoldings.yieldOnCost=0,this.portfolioHoldings.yield=0,t.forEach(o=>{let[e,i,r]=o.split(","),s={shares:+i,costAverage:+r};this.portfolioSymbols.push(e),this.portfolioHoldings[e]=s}),this.setItem("portfolioSymbols",this.portfolioSymbols),this.portfolioHoldings.positionsHeld=this.portfolioSymbols.length,g([this.getPortfolioData(),this.getPortfolioTechInsights()]).subscribe(([o,e])=>{this.portfolioData=o,this.portfolioTechnicalInsights=e,Object.entries(o).forEach(([i,r])=>{this.setItem(i,r)}),this.setItem("portfolioTechInsights",e),this.portfolioSymbols.forEach(i=>{let r=this.portfolioData[i],s=this.portfolioHoldings[i],n=s.shares,k=s.costAverage;s.symbol=i,s.totalCost=+(n*k).toFixed(2),s.marketValue=r.regularMarketPrice.raw*n,s.unrealizedGain=s.marketValue-s.totalCost,s.unrealizedGainPercent=s.unrealizedGain/s.totalCost,s.dividendIncome=r.dividendRate?.raw*n||r.dividendRate*n||0,s.yieldOnCost=s.dividendIncome/s.totalCost,this.portfolioHoldings.marketValue+=s.marketValue,this.portfolioHoldings.totalAmountInvested+=s.totalCost,this.portfolioHoldings.unrealizedGain+=s.unrealizedGain,this.portfolioHoldings.dividendIncome+=s.dividendIncome,this.portfolioHoldings[i]=s}),Object.values(this.portfolioHoldings).filter(i=>!!i.symbol).forEach(i=>{i.portfolioPercent=i.marketValue/this.portfolioHoldings.marketValue,this.setItem(i.symbol+"Holding",i)}),this.portfolioHoldings.unrealizedGainPercent=this.portfolioHoldings.unrealizedGain/this.portfolioHoldings.totalAmountInvested,this.portfolioHoldings.yield=this.portfolioHoldings.dividendIncome/this.portfolioHoldings.marketValue,this.portfolioHoldings.yieldOnCost=this.portfolioHoldings.dividendIncome/this.portfolioHoldings.totalAmountInvested,this.setItem("portfolioHoldings",this.portfolioHoldings),this.getPortfolioDividendHistory(),this.isLoadingData.next(!1),this.sanityCheck()&&this.router.navigateByUrl("/main")})}refreshPortfolioData(){this.portfolioSymbols=[],this.portfolioHoldings={},this.portfolioData={},this.portfolioTechnicalInsights={},this.portfolioDividendHistory={};let t=this.getItem("fileContent");this.localStorage?.clear(),this.generatePortfolioData(t)}getHasPortfolioData(){return this.hasPortfolioData.getValue()}getStockData(t){let o=`${this.backendUrl}/fetch/stock/${t}`;return this.wrapHttpCall(o)}getPortfolioData(){let t=this.portfolioSymbols.join(":"),o=`${this.backendUrl}/fetch/portfolio/${t}`;return this.wrapHttpCall(o)}getTechnicalInsights(t){let o=`${this.backendUrl}/fetch/technical-insights/${t}`;return this.wrapHttpCall(o)}getPortfolioTechInsights(){let t=this.portfolioSymbols.join(":"),o=`${this.backendUrl}/fetch/portfolio/technical-insights/${t}`;return this.wrapHttpCall(o)}getDividendHistory(t,o=10){let e=`${this.backendUrl}/fetch/dividend-history/${t}`,i=new I().set("years",o),r=f(d({},this.httpOptions),{params:i});return this.wrapHttpCall(e,r)}getPortfolioDividendHistory(){this.portfolioSymbols.forEach(t=>{this.getDividendHistory(t,10).subscribe(o=>{this.portfolioDividendHistory[t]=o,this.setItem(t+"DividendHistory",o)})})}getCorporateEvents(t){let o=`${this.backendUrl}/fetch/events/${t}`;return this.wrapHttpCall(o)}};l.\u0275fac=function(o){return new(o||l)(a(y),a(v),a(D))},l.\u0275prov=H({token:l,factory:l.\u0275fac,providedIn:"root"});let h=l;return h})();export{j as a};
