<ng-template #costBasisRef>
  <div class="add-flex">
    <div class="chart-container">
      <ngx-charts-pie-grid 
        [scheme]="'forest'"
        [animations]="true" 
        [results]="totalCostChartData" 
        [label]="'Dollars Invested'" 
      />
    </div>
  </div>
</ng-template>

<container-card
  title="Cost Basis"
  [mainContentRef]="costBasisRef"
/>

<div class="table-actions">
  <mat-slide-toggle (toggleChange)="tradingviewWidgetToggleHandler()">
    <span>Widgets</span>
  </mat-slide-toggle>
  <mat-form-field appearance="outline">
    <mat-label>Filter</mat-label>
    <input matInput (keyup)="applyFilter($event)" #input />
  </mat-form-field>
</div>

<table 
  mat-table
  matSort
  matSortActive="unrealizedGainPercent"
  matSortDirection="asc"
  multiTemplateDataRows
  [dataSource]="dataSource"
>
  @for (column of columnDefs; track column; let cidx = $index) {
    <div [matColumnDef]="column" [sticky]="cidx === 0">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        <span>{{ headers[cidx] }}</span>
      </th>
      <td mat-cell *matCellDef="let stock">
        @if (cidx === 0) {
          <div class="table-col-0">
            @if (!displayTradingviewWidgets) {
              <stock-name-card [stock]="stock" />
            } @else {
              <tv-single-quote-widget [symbol]="stock.symbol" class="single-quote-widget" />
            }
          </div>
        } @else if (cidx === 1) {
          <div (click)="expandRow(stock)">
            <div class="cost-average">
              <span disabled value="costAverage">${{ portfolioHoldings[stock.symbol].costAverage }}</span>
              <span disabled value="shares"> x {{ portfolioHoldings[stock.symbol].shares }}</span>
            </div>
          </div>
        } @else if (cidx === 10) {
          <span [ngStyle]="{ color: getCellColor(stock, cidx) }" (click)="expandRow(stock)">{{ stock.rating | titlecase }}</span>
        } @else {
          <span [ngStyle]="{ color: getCellColor(stock, cidx) }" (click)="expandRow(stock)">{{ cells[cidx](stock) }}</span>
        }
      </td>
  
      <td mat-footer-cell *matFooterCellDef [ngStyle]="{ color: 'black' }">
        <span>{{ footerRow[cidx]() }}</span>
      </td>
    </div>
  }

  <ng-container matColumnDef="expandedRow">
    <td mat-cell *matCellDef="let stock" [attr.colspan]="columnDefs.length">
      @if (expandedRow && expandedRow.symbol === stock.symbol) {
        <div
          class="expanded-stock-detail"
          [@detailExpand]="stock === expandedRow ? 'expanded' : 'collapsed'"
        >
          <expanded-row [stock]="stock" />
        </div>
      }
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="columnDefs; sticky: true"></tr>
  <tr 
    mat-row 
    *matRowDef="let row; columns: columnDefs"
    class="stock-row"
    [class.expanded-stock-row]="expandedRow === row"
  ></tr>
  <tr mat-row *matRowDef="let row; columns: ['expandedRow']" class="expanded-stock-row"></tr>
  <tr mat-footer-row *matFooterRowDef="columnDefs; sticky: true"></tr>
  <tr *matNoDataRow class="mat-row">
    <td class="mat-cell" colspan="4">
      <h1 class="no-match">
        <mat-icon>sentiment_very_dissatisfied</mat-icon>
        <span>Wow! Such amazing search, nothing matches: {{ input.value }}</span>
      </h1>
    </td>
  </tr>
</table>